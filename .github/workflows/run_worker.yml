# T√™n c·ªßa Workflow
name: Worker Sync & Purge (Hourly)

# K√≠ch ho·∫°t Workflow
on:
  # Ch·∫°y theo l·ªãch (Cronjob): Ch·∫°y v√†o ph√∫t th·ª© 0 c·ªßa m·ªói gi·ªù
  schedule:
    - cron: '0 * * * *'
  # Cho ph√©p ch·∫°y th·ªß c√¥ng
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Logging level (DEBUG/INFO/WARN/ERROR)'
        required: false
        default: 'INFO'

# ƒê·ªãnh nghƒ©a c√°c bi·∫øn m√¥i tr∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong t·∫•t c·∫£ c√°c steps
env:
  # Firebase Secrets
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
  FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
  # OpenSearch Secrets
  OPENSEARCH_HOST: ${{ secrets.OPENSEARCH_HOST }}
  OPENSEARCH_PORT: ${{ secrets.OPENSEARCH_PORT }}
  OPENSEARCH_USER: ${{ secrets.OPENSEARCH_USER }}
  OPENSEARCH_PASSWORD: ${{ secrets.OPENSEARCH_PASSWORD }}
  OPENSEARCH_INDEX: ${{ vars.OPENSEARCH_INDEX || 'snippets' }}
  # R2 Secrets
  R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
  R2_RECOVERY_PREFIX: ${{ vars.R2_RECOVERY_PREFIX || 'deleted_snippets/' }}
  # Logging & Notify
  D1_LOG_API_URL: ${{ secrets.D1_LOG_API_URL }}
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

# C√°c Jobs c·∫ßn ch·∫°y
jobs:
  run-worker-sync:
    runs-on: ubuntu-latest
    environment: worker # <--- ƒê√É TH√äM M√îI TR∆Ø·ªúNG 'worker'
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 
      
      # --- Caching venv (B∆Ø·ªöC M·ªöI) ---
      - name: ‚öôÔ∏è Cache Python dependencies
        uses: actions/cache@v4.3.0
        id: cache-venv
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      # --- C√†i ƒë·∫∑t dependencies (B∆Ø·ªöC M·ªöI) ---
      - name: üõ†Ô∏è Install dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          echo "Cache missed. Installing virtual environment and dependencies."
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # --- K√≠ch ho·∫°t Venv & Th·ª±c thi Worker ---
      - name: üöÄ Run Worker Script
        # Th√™m bi·∫øn m√¥i tr∆∞·ªùng LOG_LEVEL, ∆∞u ti√™n gi√° tr·ªã nh·∫≠p th·ªß c√¥ng (inputs)
        env:
          LOG_LEVEL: ${{ github.event.inputs.log_level || env.LOG_LEVEL_DEFAULT }}
        run: |
          echo "Activating virtual environment and executing worker.py..."
          # K√≠ch ho·∫°t venv (s·ª≠ d·ª•ng cache ho·∫∑c c√†i m·ªõi)
          source .venv/bin/activate
          # Ch·∫°y script Python
          python worker.py
